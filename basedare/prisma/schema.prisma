generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String     @id @default(cuid())
  walletAddress   String     @unique
  baseTag         String     @unique
  reputationScore Int        @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  dares           Dare[]
  referrals       Referral[]
}

model Dare {
  id                  String    @id @default(cuid())
  shortId             String?   @unique
  onChainDareId       String?   @unique
  title               String
  bounty              Float
  streamerHandle      String?
  status              String    @default("PENDING")
  videoUrl            String?
  proofHash           String?
  creatorId           String?
  streamId            String?
  txHash              String?
  isSimulated         Boolean   @default(false)
  expiresAt           DateTime?
  verifiedAt          DateTime?
  verifyTxHash        String?
  verifyConfidence    Float?
  appealStatus        String?
  appealReason        String?
  appealedAt          DateTime?
  referrerTag         String?
  referrerAddress     String?
  referrerPayout      Float?
  stakerAddress       String?
  inviteToken         String?   @unique
  claimDeadline       DateTime?
  targetWalletAddress String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  discoveryRadiusKm   Float?    @default(5)
  geohash             String?
  isNearbyDare        Boolean   @default(false)
  latitude            Float?
  locationLabel       String?
  longitude           Float?
  // Claim-to-attempt fields (for @everyone open dares)
  claimedBy           String?   // Wallet that claimed this dare
  claimedAt           DateTime? // When it was claimed
  claimExpiresAt      DateTime? // When the claim expires (24h window)
  // Moderator decision fields
  moderatorDecision   String?   // APPROVED or REJECTED
  moderatorAddress    String?   // Wallet of moderator who decided
  moderatedAt         DateTime? // When moderation happened
  moderatorNote       String?   // Optional note from moderator
  // Vote threshold tracking
  voteThreshold       Int       @default(5)  // Votes needed for mod review
  creator             User?     @relation(fields: [creatorId], references: [id])
  votes               Vote[]

  @@index([inviteToken])
  @@index([streamerHandle, status])
  @@index([geohash])
  @@index([isNearbyDare, status])
  @@index([claimedBy])
  @@index([status, videoUrl])
}

model Referral {
  id          String   @id @default(cuid())
  code        String   @unique
  ownerId     String
  usageCount  Int      @default(0)
  totalEarned Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  owner       User     @relation(fields: [ownerId], references: [id])
}

model StreamerTag {
  id                   String    @id @default(cuid())
  tag                  String    @unique
  walletAddress        String
  verificationMethod   String
  verifiedAt           DateTime?
  twitterId            String?   @unique
  twitterHandle        String?
  twitterVerified      Boolean   @default(false)
  twitchId             String?   @unique
  twitchHandle         String?
  twitchVerified       Boolean   @default(false)
  youtubeId            String?   @unique
  youtubeHandle        String?
  youtubeVerified      Boolean   @default(false)
  kickHandle           String?
  kickVerificationCode String?
  kickVerified         Boolean   @default(false)
  status               String    @default("PENDING")
  revokedAt            DateTime?
  revokedBy            String?
  revokeReason         String?
  totalEarned          Float     @default(0)
  completedDares       Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([walletAddress])
  @@index([twitterHandle])
  @@index([status])
}

model Brand {
  id            String     @id @default(cuid())
  name          String
  logo          String?
  walletAddress String     @unique
  verified      Boolean    @default(false)
  totalSpend    Float      @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  campaigns     Campaign[]
}

model Campaign {
  id                   String         @id @default(cuid())
  shortId              String         @unique @default(cuid())
  brandId              String
  tier                 String
  title                String
  description          String?
  budgetUsdc           Float
  creatorCountTarget   Int
  payoutPerCreator     Float
  targetingCriteria    String         @default("{}")
  verificationCriteria String         @default("{}")
  syncTime             DateTime?
  windowHours          Int            @default(24)
  strikeWindowMinutes  Int            @default(10)
  precisionMultiplier  Float          @default(1.0)
  status               String         @default("DRAFT")
  vetoWindowEndsAt     DateTime?
  vetoCount            Int            @default(0)
  maxVetoPercent       Int            @default(25)
  rakePercent          Int            @default(30)
  fundedAt             DateTime?
  liveAt               DateTime?
  settledAt            DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  brand                Brand          @relation(fields: [brandId], references: [id])
  slots                CampaignSlot[]
}

model CampaignSlot {
  id               String    @id @default(cuid())
  campaignId       String
  scoutId          String?
  creatorAddress   String?
  creatorHandle    String?
  creatorFollowers Int?
  claimRationale   String?
  claimedAt        DateTime?
  status           String    @default("OPEN")
  submittedAt      DateTime?
  proofUrl         String?
  proofHash        String?
  visualScore      Float?
  audioScore       Float?
  metadataPass     Boolean?
  totalConfidence  Float?
  basePayout       Float?
  precisionBonus   Float?
  totalPayout      Float?
  discoveryRake    Float?
  activeRake       Float?
  paidAt           DateTime?
  payoutTxHash     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  campaign         Campaign  @relation(fields: [campaignId], references: [id])
  scout            Scout?    @relation(fields: [scoutId], references: [id])
}

model Scout {
  id                 String         @id @default(cuid())
  walletAddress      String         @unique
  handle             String?
  reputationScore    Int            @default(50)
  totalCampaigns     Int            @default(0)
  successfulSlots    Int            @default(0)
  failedSlots        Int            @default(0)
  tier               String         @default("BLOODHOUND")
  totalDiscoveryRake Float          @default(0)
  totalActiveRake    Float          @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  slots              CampaignSlot[]
  activeCreators     ScoutCreator[] @relation("ActiveScout")
  discoveredCreators ScoutCreator[] @relation("DiscoveryScout")
}

model ScoutCreator {
  id                       String   @id @default(cuid())
  creatorAddress           String   @unique
  creatorHandle            String?
  discoveryScoutId         String
  discoveredAt             DateTime @default(now())
  activeScoutId            String?
  lastActiveAt             DateTime @default(now())
  totalCompletions         Int      @default(0)
  bindingStatus            String   @default("BOUND")
  totalDiscoveryRakeEarned Float    @default(0)
  totalActiveRakeEarned    Float    @default(0)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  activeScout              Scout?   @relation("ActiveScout", fields: [activeScoutId], references: [id])
  discoveryScout           Scout    @relation("DiscoveryScout", fields: [discoveryScoutId], references: [id])
}

model LivePot {
  id                 String    @id @default(cuid())
  balance            Float     @default(0)
  totalDeposited     Float     @default(0)
  totalDistributed   Float     @default(0)
  totalSlashed       Float     @default(0)
  lastDepositAt      DateTime?
  lastDistributionAt DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model PotTransaction {
  id               String   @id @default(cuid())
  type             String
  amount           Float
  balanceAfter     Float
  sourceType       String?
  sourceId         String?
  recipientAddress String?
  recipientType    String?
  description      String?
  createdAt        DateTime @default(now())
}

model LeaderboardEntry {
  id             String   @id @default(cuid())
  period         String
  periodStart    DateTime
  periodEnd      DateTime
  entityType     String
  entityAddress  String
  entityHandle   String?
  totalVolume    Float    @default(0)
  completedCount Int      @default(0)
  successRate    Float    @default(0)
  avgPayout      Float    @default(0)
  rank           Int?
  previousRank   Int?
  rewardEarned   Float    @default(0)
  rewardTxHash   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([period, periodStart, entityType, entityAddress])
}

model WeeklyRewardDistribution {
  id                 String    @id @default(cuid())
  weekStart          DateTime  @unique
  weekEnd            DateTime
  potBalanceBefore   Float
  distributionAmount Float
  potBalanceAfter    Float
  status             String    @default("PENDING")
  creatorRewards     String    @default("[]")
  scoutRewards       String    @default("[]")
  processedAt        DateTime?
  processedBy        String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================================================
// COMMUNITY VOTING SYSTEM
// ============================================================================

model Vote {
  id            String   @id @default(cuid())
  dareId        String
  walletAddress String
  voteType      String   // APPROVE or REJECT
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  dare          Dare     @relation(fields: [dareId], references: [id], onDelete: Cascade)

  @@unique([dareId, walletAddress])
  @@index([dareId])
  @@index([walletAddress])
}

model VoterPoints {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  totalPoints   Int      @default(0)
  correctVotes  Int      @default(0)
  totalVotes    Int      @default(0)
  streak        Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([totalPoints])
}
