generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}
model User {
  id String @id @default(cuid())
  walletAddress String @unique
  baseTag String @unique
  reputationScore Int @default(0)
  dares Dare[]
  referrals Referral[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Dare {
  id String @id @default(cuid())
  shortId String? @unique
  title String
  bounty Float
  streamerHandle String
  status String @default("PENDING")
  videoUrl String?
  proofHash String?
  // Optional user relation for anonymous dares
  creatorId String?
  creator User? @relation(fields: [creatorId], references: [id])
  // On-chain tracking
  streamId String?
  txHash String?
  isSimulated Boolean @default(false)
  // Expiry tracking
  expiresAt DateTime?
  // Verification & Appeal
  verifiedAt DateTime?
  verifyTxHash String?
  verifyConfidence Float?
  appealStatus String? // NONE, PENDING, APPROVED, REJECTED
  appealReason String?
  appealedAt DateTime?
  // Referral tracking
  referrerTag String?
  referrerAddress String?
  referrerPayout Float?
  // Staker tracking
  stakerAddress String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Referral {
  id String @id @default(cuid())
  code String @unique
  ownerId String
  owner User @relation(fields: [ownerId], references: [id])
  usageCount Int @default(0)
  totalEarned Float @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// CONTROL MODE - BRAND PORTAL MODELS
// The B2B infrastructure for programmatic attention marketing
// ============================================================================

model Brand {
  id            String   @id @default(cuid())
  name          String
  logo          String?
  walletAddress String   @unique
  verified      Boolean  @default(false) // KYB status

  // Stats
  totalSpend    Float    @default(0)

  // Relations
  campaigns     Campaign[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Campaign {
  id                  String   @id @default(cuid())
  shortId             String   @unique @default(cuid())

  // Brand relation
  brandId             String
  brand               Brand    @relation(fields: [brandId], references: [id])

  // Campaign tier: SIP_MENTION | SIP_SHILL | CHALLENGE | APEX
  tier                String
  title               String
  description         String?

  // Budget & Slots
  budgetUsdc          Float
  creatorCountTarget  Int
  payoutPerCreator    Float    // Base payout before bonuses

  // Targeting criteria (JSON: { niche, min_followers, location, etc })
  targetingCriteria   String   @default("{}")

  // Verification requirements (JSON: { product_visible, cta_spoken, hashtags, etc })
  verificationCriteria String  @default("{}")

  // Sync configuration (tier-based defaults)
  syncTime            DateTime?
  windowHours         Int      @default(24) // Broad window for base payout
  strikeWindowMinutes Int      @default(10) // Precision window for bonus
  precisionMultiplier Float    @default(1.0) // 1.0 = no bonus, 1.3-1.5 = bonus

  // Status: DRAFT | FUNDING | RECRUITING | LIVE | VERIFYING | SETTLED | CANCELLED
  status              String   @default("DRAFT")

  // Veto window for brand to reject claims
  vetoWindowEndsAt    DateTime?
  vetoCount           Int      @default(0)
  maxVetoPercent      Int      @default(25) // Cap at 25% of slots

  // Platform rake (25-35% for B2B)
  rakePercent         Int      @default(30)

  // Relations
  slots               CampaignSlot[]

  // Timestamps
  fundedAt            DateTime?
  liveAt              DateTime?
  settledAt           DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model CampaignSlot {
  id                String   @id @default(cuid())

  // Campaign relation
  campaignId        String
  campaign          Campaign @relation(fields: [campaignId], references: [id])

  // Scout who claimed this slot
  scoutId           String?
  scout             Scout?   @relation(fields: [scoutId], references: [id])

  // Creator assigned to this slot
  creatorAddress    String?
  creatorHandle     String?
  creatorFollowers  Int?

  // Claim metadata (JSON: Scout's pitch/rationale)
  claimRationale    String?
  claimedAt         DateTime?

  // Status: OPEN | CLAIMED | VETOED | ASSIGNED | SUBMITTED | VERIFIED | PAID | FORFEITED
  status            String   @default("OPEN")

  // Submission tracking
  submittedAt       DateTime?
  proofUrl          String?
  proofHash         String?

  // Verification scores (from AI Referee)
  visualScore       Float?
  audioScore        Float?
  metadataPass      Boolean?
  totalConfidence   Float?

  // Payout calculation
  basePayout        Float?
  precisionBonus    Float?
  totalPayout       Float?

  // Scout rake tracking
  discoveryRake     Float?   // 0.5% to discovery scout
  activeRake        Float?   // 0.5% to placing scout

  // Settlement
  paidAt            DateTime?
  payoutTxHash      String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Scout {
  id                String   @id @default(cuid())
  walletAddress     String   @unique
  handle            String?

  // Reputation system
  reputationScore   Int      @default(50) // 0-100, starts at 50
  totalCampaigns    Int      @default(0)
  successfulSlots   Int      @default(0)
  failedSlots       Int      @default(0)

  // Tier: BLOODHOUND (0-25 campaigns) | ARBITER (25-100) | ARCHON (100+)
  tier              String   @default("BLOODHOUND")

  // Earnings tracking
  totalDiscoveryRake Float   @default(0)
  totalActiveRake    Float   @default(0)

  // Relations
  slots             CampaignSlot[]
  discoveredCreators ScoutCreator[] @relation("DiscoveryScout")
  activeCreators     ScoutCreator[] @relation("ActiveScout")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ScoutCreator {
  id                String   @id @default(cuid())

  // The creator being managed
  creatorAddress    String
  creatorHandle     String?

  // Discovery scout (permanent 0.5% rake)
  discoveryScoutId  String
  discoveryScout    Scout    @relation("DiscoveryScout", fields: [discoveryScoutId], references: [id])
  discoveredAt      DateTime @default(now())

  // Active management scout (earnable 0.5% rake)
  activeScoutId     String?
  activeScout       Scout?   @relation("ActiveScout", fields: [activeScoutId], references: [id])

  // Activity tracking for decay
  lastActiveAt      DateTime @default(now())
  totalCompletions  Int      @default(0)

  // Binding status: BOUND | UNBOUND | PENDING_UNBIND
  bindingStatus     String   @default("BOUND")

  // Rake earnings for this specific creator
  totalDiscoveryRakeEarned Float @default(0)
  totalActiveRakeEarned    Float @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([creatorAddress])
}

// ============================================================================
// LIVE POT (SUNDER POOL) - COMMUNITY WAR CHEST
// Progressive jackpot fed by fees and slashing
// ============================================================================

model LivePot {
  id              String   @id @default(cuid())

  // Current balance in USDC
  balance         Float    @default(0)

  // Lifetime stats
  totalDeposited  Float    @default(0)
  totalDistributed Float   @default(0)
  totalSlashed    Float    @default(0) // From Sunder events

  // Last update
  lastDepositAt   DateTime?
  lastDistributionAt DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PotTransaction {
  id              String   @id @default(cuid())

  // Transaction type: DEPOSIT_P2P | DEPOSIT_B2B | SUNDER | WEEKLY_REWARD | LEGENDARY_DARE
  type            String

  // Amount (positive = deposit, negative = withdrawal)
  amount          Float

  // Balance after transaction
  balanceAfter    Float

  // Reference to source (dare ID, campaign ID, etc.)
  sourceType      String?  // DARE | CAMPAIGN | ADMIN
  sourceId        String?

  // For rewards: recipient info
  recipientAddress String?
  recipientType   String?  // CREATOR | SCOUT

  // Description
  description     String?

  createdAt       DateTime @default(now())
}

// ============================================================================
// LEADERBOARD - COMPETITIVE RANKINGS
// Track top performers for weekly rewards
// ============================================================================

model LeaderboardEntry {
  id              String   @id @default(cuid())

  // Period: WEEKLY | MONTHLY | ALL_TIME
  period          String
  periodStart     DateTime
  periodEnd       DateTime

  // Entity
  entityType      String   // CREATOR | SCOUT
  entityAddress   String
  entityHandle    String?

  // Stats for the period
  totalVolume     Float    @default(0)  // Total $ settled
  completedCount  Int      @default(0)  // Number of completions
  successRate     Float    @default(0)  // Success percentage
  avgPayout       Float    @default(0)  // Average payout per completion

  // Ranking
  rank            Int?
  previousRank    Int?     // For showing movement

  // Rewards earned this period
  rewardEarned    Float    @default(0)
  rewardTxHash    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([period, periodStart, entityType, entityAddress])
}

model WeeklyRewardDistribution {
  id              String   @id @default(cuid())

  // Period
  weekStart       DateTime
  weekEnd         DateTime

  // Pot state
  potBalanceBefore Float
  distributionAmount Float
  potBalanceAfter Float

  // Status: PENDING | PROCESSING | COMPLETED | FAILED
  status          String   @default("PENDING")

  // Rewards JSON array
  creatorRewards  String   @default("[]") // JSON array of creator rewards
  scoutRewards    String   @default("[]") // JSON array of scout rewards

  // Processing
  processedAt     DateTime?
  processedBy     String?  // Admin wallet

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([weekStart])
}
